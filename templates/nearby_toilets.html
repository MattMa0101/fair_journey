{% load staticfiles %}
<html>
<head>
    <meta charset=utf-8 />
    <title>Public Toilets</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v1.3.0/turf.min.js'></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.0.1/mapbox.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.0.1/mapbox.css' rel='stylesheet' />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.48.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.48.0/mapbox-gl.css' rel='stylesheet' />
    <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />

    <!-- Bootstrap CSS-->
    <link rel="stylesheet" href="{% static "assets/vendor/bootstrap/css/bootstrap.min.css" %}">
    <!-- Font Awesome CSS-->
    <link rel="stylesheet" href="{% static "assets/vendor/font-awesome/css/font-awesome.min.css" %}">
    <!-- Fontastic Custom icon font-->
    <link rel="stylesheet" href="{% static "assets/css/fontastic.css" %}">
    <!-- Google fonts - Roboto -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700">
    <!-- jQuery Circle-->
    <link rel="stylesheet" href="{% static "assets/css/grasp_mobile_progress_circle-1.0.0.min.css" %}">
    <!-- Custom Scrollbar-->
    <link rel="stylesheet" href="{% static "assets/vendor/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.css" %}">
    <!-- theme stylesheet-->
    <link rel="stylesheet" href="{% static "assets/css/style.default.css" %}" id="theme-stylesheet">
    <!-- Custom stylesheet - for your changes-->
    <link rel="stylesheet" href="{% static "assets/css/custom.css" %}">
    <!-- Favicon-->
    <link rel="shortcut icon" href="{% static "assets/img/favicon.ico" %}">
    <!-- Tweaks for older IEs--><!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]-->
    <!-- JavaScript files-->
    <script src="{% static "assets/vendor/jquery/jquery.min.js" %}"></script>
    <script src="{% static "assets/vendor/popper.js/umd/popper.min.js" %}"> </script>
    <script src="{% static "assets/vendor/bootstrap/js/bootstrap.min.js" %}"></script>
    <script src="{% static "assets/js/grasp_mobile_progress_circle-1.0.0.min.js" %}"></script>
    <script src="{% static "assets/vendor/jquery.cookie/jquery.cookie.js" %}"> </script>
    <script src="{% static "assets/vendor/chart.js/Chart.min.js" %}"></script>
    <script src="{% static "assets/vendor/jquery-validation/jquery.validate.min.js" %}"></script>
    <script src="{% static "assets/vendor/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js" %}"></script>
    <script src="{% static "assets/js/charts-home.js" %}"></script>
    <!-- Main File-->
    <script src="{% static "assets/js/front.js" %}"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
    <link rel="shortcut icon" href="{% static "assets/images/logo2.png" %}" type="image/x-icon">
    <meta name="description" content="">
    <title>Home</title>
    <link rel="stylesheet" href="{% static "assets/web/assets/mobirise-icons/mobirise-icons.css" %}">
    <link rel="stylesheet" href="{% static "assets/tether/tether.min.css" %}">
    <link rel="stylesheet" href="{% static "assets/bootstrap/css/bootstrap.min.css" %}">
    <link rel="stylesheet" href="{% static "assets/bootstrap/css/bootstrap-grid.min.css" %}">
    <link rel="stylesheet" href="{% static "assets/bootstrap/css/bootstrap-reboot.min.css" %}">
    <link rel="stylesheet" href="{% static "assets/dropdown/css/style.css" %}">
    <link rel="stylesheet" href="{% static "assets/socicon/css/styles.css" %}">
    <link rel="stylesheet" href="{% static "assets/theme/css/style.css" %}">
    <link rel="stylesheet" href="{% static "assets/mobirise/css/mbr-additional.css" %}" type="text/css">




    <style>

        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
        .leaflet-popup-content .marker-title{font-weight:500;color:#999;line-height:1.3em;}
        .marker-title span{color:#00704A;font-weight:bold;}
        #distanceCount{line-height:2em;color:dodgerblue}
        .space-left2 {margin-left: 20px;}

        #instructions {
            margin: 1px;
            width: 100%;
            top: 0;
            bottom: 0;
            padding: 1px;
            background-color: #474a56;
            overflow-y: scroll;
            font-family: Verdana;
            font-size: 11px;
            font-weight:500;
            color:white;
            opacity: 1;
        }
        ul.pin-top {
            border-radius: 3px;
            opacity: 1;
            font-size:11px;
            top:100px;
            left:5px;
            background-color: #474a56;
            color:white;
        }

        ul.pin-top li {
            padding: 1em;
            background-color: #474a56;
            color:white;
            opacity: 1;
        }

        span.label {
            display: block;
            font-size:11px;
        }

        li.fill-white {
            padding: .5em 1em 1em 1em;
            background-color: #474a56;
            color:white;
            opacity: 1;

        }

        li.content {
            display: none;
            background-color: #474a56;
            color:white;
            opacity: 1;

        }

        li.fill-white .content {
            display: block;
            background-color: #474a56;
            color:white;
            opacity: 1;
        }

        li.fill-white span.label, li.fill-purple span.label, li.fill-green span.label {
            text-transform: uppercase;
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 1em;
            opacity: 1;
        }

        li.fill-green, li.fill-purple {
            color: #ffff;
            opacity: 1;
        }

        .fill-blue {
        background: #3887be;
        font-size: 11px;
        }

        .fr {
        float: left;
        }
        .elevGraph {
            fill: deepskyblue;
            stroke: none;
            opacity: 0.4;
            stroke-width: 4px;
        }

        #title-block {
            height: 60px;
        }

        #tooltip {
            display:none;
            position: absolute;
            top:0;
            left:0;
        }

        #searchresults {
            width: 200%;
            background: #FFF;
            color:#323643;
        }
        .marker-hover {
            background: steelblue;
            border-radius: 50%;
            border: 2px solid white;
            height: 20px;
        }
        .focus circle {
            fill: steelblue;
            stroke: white;
        }

        #geolocate { display: none; }
    </style>
</head>
<body>

<script src="{% static "assets/web/assets/jquery/jquery.min.js" %}"></script>
<script src="{% static "assets/popper/popper.min.js" %}"></script>
<script src="{% static "assets/tether/tether.min.js" %}"></script>
<script src="{% static "assets/bootstrap/js/bootstrap.min.js" %}"></script>
<script src="{% static "assets/smoothscroll/smooth-scroll.js" %}"></script>
<script src="{% static "assets/dropdown/js/script.min.js" %}"></script>
<script src="{% static "assets/ytplayer/jquery.mb.ytplayer.min.js" %}"></script>
<script src="{% static "assets/vimeoplayer/jquery.mb.vimeo_player.js" %}"></script>
<script src="{% static "assets/bootstrapcarouselswipe/bootstrap-carousel-swipe.js" %}"></script>
<script src="{% static "assets/touchswipe/jquery.touch-swipe.min.js" %}"></script>
<script src="{% static "assets/theme/js/script.js" %}"></script>
<script src="{% static "assets/slidervideo/script.js" %}"></script>


    <nav class="navbar navbar-default navbar-fixed-top probootstrap-navbar">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="{% url 'index' %}" title="uiCookies:FineOak">Fair Journey</a>
        </div>

        <div id="navbar-collapse" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="{% url 'index' %}">Home</a></li>
            <li><a href="{% url 'service' %}">Our Services</a></li>
            <li><a href="{% url 'about' %}">About Us</a></li>
            <!--<li><a href="gallery.html">Gallery</a></li>
            <li class="dropdown">
              <a href="#" data-toggle="dropdown" class="dropdown-toggle">Pages</a>
              <ul class="dropdown-menu">
                <li><a href="about.html">About Us</a></li>
                <li><a href="portfolio.html">Portfolio</a></li>
                <li><a href="portfolio-single.html">Portfolio Single</a></li>
                <li class="dropdown-submenu dropdown">
                  <a href="#" data-toggle="dropdown" class="dropdown-toggle"><span>Sub Menu</span></a>
                  <ul class="dropdown-menu">
                    <li><a href="#">Second Level Menu</a></li>
                    <li><a href="#">Second Level Menu</a></li>
                    <li><a href="#">Second Level Menu</a></li>
                    <li><a href="#">Second Level Menu</a></li>
                  </ul>
                </li>
                <li><a href="services.html">Services</a></li>
              </ul>
            </li>
            <li><a href="{% url 'contact' %}">Contact</a></li>-->
          </ul>
        </div>
      </div>
    </nav>

<div id='map'></div>
<!--<ul class='pin-top pad1 quiet space-top2 space-left2 col3'>-->
             <ul class='pin-top quiet col3'>

    <li id='title-block' class='fill-denim dark keyline-bottom'>
        <!--<p class='col10 space-top0'>Find Nearby Public Transportation</p>-->
        <!--<p class='col2 button fr fill-denim icon refresh short'></p>-->
        <div class='col4 margin1 button short fr fill-blue refresh'> Reset Map</div>
        <div class='col4 margin1 button short fr fill-blue' id='findme'>Find Me</div>
    </li>

    <li id='dst-location' class='fill-white keyline-bottom'>
        <!--<span class='label'>Choose starting location</span>-->
        <div class='content'>
            <div>
                <span id='distanceCount' class='strong'>0</span> Public Toilets found within 1km
            </div>
            <div id='geolocate' class='row1 space-top1'>
                <fieldset class="col6 with-icon">
                    <span class="icon search" style="top:5px; left:5px"></span>
                    <input type="text" placeholder="Search" class="round short" autocomplete="on" style="width:200%; margin-right:5px">
                    <div id="searchresults"></div>
                </fieldset>

            </div>
        </div>
        <div class='selection'>
        </div>
    </li>
    <li id='destination' class='fill-gray keyline-bottom'>
        <span class='label'>Destination</span>
        <div class='selection'></div>
    </li>
    <li id='route-info' class='fill-gray'>
        <p><span class='label'><b>STEPS:</b></span></p>
        <div id='instructions' class='content row6'>
            <p><span class='label'><b>Route Distance: </b></span> <span id='routedist'></span>m</p>
            <p class='col6'><span class='label'><b>Max elevation: </b></span> <span id='max-elev'></span></p>
            <p class='col6'><span class='label'><b>Min elevation:</b></span> <span id='min-elev'></span></p>

            <!--<p><span class='label'><b>Steps:</b></span></p>-->
        </div>
    </li>
    <div id='tooltip' class='col4'></div>
    <div class='content row1'> <p><span class='label', style="font-size: 11px; font-weight: bold; text-align: left"><b>&nbsp;&nbsp;&nbsp;&nbsp;ELEVATION CHART</b></span></div>
    <p><br><br><br></p>
    <div class="row3 pin-bottom js-chartdiv">
        <div id='chart'></div>
    </div>
</ul>
         </div>
<script>
    L.mapbox.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejkyYm9qbjAwdm8yd3RlaXNtZmN3a3gifQ.Uc9LFNtZpBHYc00cU-tQUA';
    var map = L.mapbox.map('map', 'duncangraham.b134a19e', { zoomControl: false })
        .setView([-37.81, 144.98], 16);

    var isEmbed = location.search;
    isEmbed = isEmbed.slice(1);

    if ( isEmbed == 'embed' ) {
        new L.Control.Zoom({ position: 'topright' }).addTo(map);
        map.scrollWheelZoom.disable();
    }

    var marker = L.marker(new L.LatLng(-37.81, 144.98), {
        icon: L.mapbox.marker.icon({
            "marker-color": "#4ecca3",
            "title": "Your Location",
            "marker-symbol": "pitch",
            "marker-size": "large"    }),
        draggable: true,
        zIndexOffset:999
    });

    var start,
        destination,
        resampledRoute;

    var currentPosition;
    //geolocation
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        }
    }

    function showPosition(position) {
        currentPosition=[position.coords.latitude, position.coords.longitude];
        $('#geolocate').show();
    }

    function pointBuffer (pt, radius, units, resolution) {
        var ring = []
        var resMultiple = 360/resolution;
        for(var i  = 0; i < resolution; i++) {
            var spoke = turf.destination(pt, radius, i*resMultiple, units);
            ring.push(spoke.geometry.coordinates);
        }
        if((ring[0][0] !== ring[ring.length-1][0]) && (ring[0][1] != ring[ring.length-1][1])) {
            ring.push([ring[0][0], ring[0][1]]);
        }
        return turf.polygon([ring])
    }

    $.get("{% static "toilets.geojson" %}", function(data){
        //test if data is JSON
        if(typeof data == 'object') {
            var fc = data;
        } else {
            var fc = JSON.parse(data);
        }

        $('#findme').on('click', function(){
            //$('#findme').on('click', function(){
            marker.setLatLng(currentPosition);
            map.setView(currentPosition,18);
            updateVenues();
        });

        //input search functionality
        $('fieldset input').keyup(function(event) {
            var contents=$('fieldset input').val();
            var url='https://api.tiles.mapbox.com/v4/geocode/mapbox.places/'+contents+'.json?access_token='+L.mapbox.accessToken;

            $.get(url, function(data){
                $('.result').remove();
                data.features.forEach(function(result){
                    var place = result['place_name'];
                    var reg = new RegExp(contents,"gi");
                    place = place.replace(reg, function (match) {return "<strong>" + match + "</strong>"});
                    $('#searchresults')
                        .append('<div class="result keyline-bottom keyline-left keyline-right small">'+place+'</div>')
                });
                $('.result').each(function(index){
                    var coords= (data.features[index]['center']);
                    $(this).on('click', function(){
                        $('.result').remove();
                        map.setView([coords[1], coords[0]], 13);
                        marker.setLatLng([coords[1], coords[0]]);
                        updateVenues();
                    })
                })
            })

            if (event.keyCode == 13) {
                geocoder.query(contents, showMap);
                $('input').blur();
            }
        });

        // get position, draw buffer, find within, find nearest, add to map
        function updateVenues(){
            $('path').remove();
            $('.leaflet-marker-pane img').not(':first').remove();
            var position=marker.getLatLng();

            var point=turf.point([position.lng, position.lat]);

            //draw walking nearby buffer
            var bufferLayer = L.mapbox.featureLayer().addTo(map);
            var buffer = pointBuffer(point, 1, 'kilometers', 100);
            buffer.properties = {
                "fill": "#00704A",
                "fill-opacity":0.2,
                "stroke": "#00704A",
                "stroke-width": 2,
                "stroke-opacity": 0.5
            };

            bufferLayer.setGeoJSON(buffer);
            //var within = turf.within(fc,bufferLayer.getGeoJSON());
            var within = turf.featurecollection(fc.features.filter(function(place){
                if (turf.distance(place, point, 'kilometers') <= 1) return true;
            }));
            $('#distanceCount').html(within.features.length);
            function kmConvert(kilometers){
                if (kilometers<=2){
                    return (kilometers*1000).toFixed(0)+' meters';
                } else {
                    return kilometers.toFixed(2) +' km';
                }
            }
            //show all nearby toilets
            within.features.forEach(function(feature){
                var distance = parseFloat(turf.distance(point, feature, 'kilometers'));
                feature.properties["marker-color"] = "C73E3E";
                feature.properties["title"] = '<span>'+kmConvert(distance)+'(Near)</span><br>Name: '+feature.properties["name"]+'<br>Operator: '+feature.properties["operator"]+' <br>Wheelchair: '+feature.properties["wheelchair"];
                feature.properties["marker-size"] = "small";
                feature.properties["marker-symbol"] = "toilets";
            })

            //show nearest toilet
            var nearest = turf.nearest(point, fc);
            var nearestdist = parseFloat(turf.distance(point, nearest, 'kilometers'));

            nearest.properties["marker-color"] = "C73E3E";
            nearest.properties["title"] = '<span>'+kmConvert(nearestdist)+'(Nearest)</span><br>Name: '+nearest.properties["name"]+'<br>Operator: '+nearest.properties["operator"]+' <br>Wheelchair: '+nearest.properties["wheelchair"];
            nearest.properties["marker-size"] = "large";
            nearest.properties["marker-symbol"] = "toilets";


            var nearest_fc = L.mapbox.featureLayer().setGeoJSON(turf.featurecollection([within, nearest])).addTo(map);

            //nearest_fc.openPopup();     //open Popup menu by default without mouseover
            nearest_fc.on('mouseover', function(e) {
                e.layer.openPopup();
            });
            nearest_fc.on('mouseout', function(e) {
                e.layer.closePopup();
            });

            // Start Navigation by click the marker
            nearest_fc.on('click', function(e){
                destination = turf.point([e.latlng.lng, e.latlng.lat]);
                e.layer.openPopup();
                //highlight starting location
                destination.properties["marker-color"] = '4ecca3';
                destination.properties["marker-size"] = "small";
                destination.properties["marker-symbol"] = "toilets";


                //update model
                $('#destination').removeClass('fill-white').addClass('fill-green');
                $('#destination .content').hide();
                $('#destination.label').text('Destination');
                $('#destination .selection').text(e.layer.feature.properties["name"]);
                //step2
                $('#destination').removeClass('fill-gray').addClass('fill-white');
                $('#destination .content').show();

                //Set start location to marker
                start = turf.point([marker.getLatLng().lng, marker.getLatLng().lat]);


                //var destinationLayer = L.mapbox.featureLayer().setGeoJSON(turf.featurecollection([destination])).addTo(map);

                //update model
                $('#start-location').removeClass('fill-white').addClass('fill-purple');
                $('#start-location .content').hide();
                $('#start-location .label').text('start-location');
                //step2
                $('#route-info').removeClass('fill-gray').addClass('fill-white');
                $('#route-info .content').show();

                map.removeEventListener('mousemove');
                getRouteInfo(start, destination);
            })

        }


        marker.on('drag', function(){updateVenues()});
        updateVenues();

        var elevProfile = []
        var queryPoints = []


        function getRouteInfo ( start, end ) {
            var startCoord = start.geometry.coordinates.toString();
            var endCoord = end.geometry.coordinates.toString();
            var directionsURL = 'https://api.tiles.mapbox.com/v4/directions/mapbox.walking/'+ startCoord + ';' + endCoord +'.json?steps=true&geometries=geojson&access_token=' + L.mapbox.accessToken;
            console.log(directionsURL);
            $.get(directionsURL, function(data){
                console.log(data);
                var route = data.routes[0].geometry;
                var geoJSON = {
                    "type": "Feature",
                    "properties": {"stroke":"#63aebb",
                        "stroke-width":"5"}
                }
                geoJSON.geometry = route;

                //add route to map
                map.featureLayer.setGeoJSON(geoJSON);

                //update modal
                var distance = data.routes[0].distance;
                distance = distance.toFixed(2);
                $('#routedist').text(distance);


                // Create  instructions
                //clear the div first (before changing location
                document.getElementById("instructions").innerHTML = "";

                //update instructions
                var instructions = document.getElementById('instructions');
                var steps = data.routes[0].steps;
                steps.forEach(function(step) {
                    instructions.insertAdjacentHTML('beforeend', '<p>' + step.maneuver.instruction + '</p>');
                });
                //get surface data
                makeSurfaceCall(route);
            });
        }


        function makeSurfaceCall ( points ) {
            points = points.coordinates;
            elevProfile = [];
            queryPoints = [];
            var pointString = '';
            points.forEach(function(arr){
                pointString = pointString + arr.toString() + ';';
            })
            pointString = pointString.slice(0, -1);
            var surfaceURL = 'https://api.tiles.mapbox.com/v4/surface/mapbox.mapbox-terrain-v2.json?layer=contour&fields=ele&points=' + pointString + '&access_token=' + L.mapbox.accessToken;
            //var surfaceURL = 'https://api.mapbox.com/v4/mapbox.terrain-rgb/1/0/0.pngraw?layer=contour&fields=ele&points=' + pointString + '&access_token=' + L.mapbox.accessToken;

            $.get(surfaceURL, function(data){
                //create elevation profile
                var results = data.results;
                results.forEach(function(point) {
                    elevProfile.push(point.ele);
                    queryPoints.push([point.latlng.lat, point.latlng.lng]);
                })
                drawChart(elevProfile);
            })
        }

        function formatElev(elev) {
            return Math.round(elev) + ' m';
        }

        var hover = L.marker([], {
            icon: L.divIcon({
                className: 'marker-hover',
                iconSize: 20,
                iconAnchor: [10, 10]
            })
        });

        function drawChart ( elevData ) {
            $('#chart').html("");
            var hWind = $('.js-chartdiv').height();
            var wWind = $('.js-chartdiv').width();
            var minElev = d3.min(elevData);
            var maxElev = d3.max(elevData);
            $('#max-elev').text(formatElev(maxElev));
            $('#min-elev').text(formatElev(minElev));
            var margins = [20, 20, 20, 20],
                w = wWind - margins[1] - margins[3],
                h = hWind - margins[0] - margins[2];

            var x1 = d3.scale.linear()
                .domain([0, elevData.length])
                .range([0, w]);

            var y1 = d3.scale.linear()
                .domain([minElev - 10, d3.max(elevData) + 10])
                .range([h, 0]);

            var area = d3.svg.area()
                .x(function(d, i) {
                    return x1(i);
                })
                .y0(h)
                .y1(function(d) {
                    return y1(d);
                });
            //d3 goodness
            var graph = d3.select("#chart").append("svg:svg")
                .attr("width", w + margins[1] + margins[3])
                .attr("height", h + margins[0] + margins[2])
                .append("svg:g")
                .attr("transform", "translate(" + margins[3] + "," + margins[0] + ")")
                .on('mouseover', function() {
                    focusElev.style('display', null);
                })
                .attr('class', 'profileGraph')
                .on('mouseout', function() {
                    focusElev.style('display', 'none');
                    map.removeLayer(hover);
                })
                .on('mousemove', chartMouseover);

            graph.append("path")
                .attr("d", area(elevData))
                .attr('class', 'elevGraph');

            var focusElev = graph.append('g')
                .attr('class', 'focus')
            //.style('display', 'none');

            focusElev.append('circle')
                .attr('r', 6)
                .attr('fill', 'chart-elevation-circle')

            focusElev.append('text')
                .attr('x', 9)
                .attr('fill', 'white')
                .attr('dy', '.35em');

            function chartMouseover() {
                var x0 = x1.invert(d3.mouse(this)[0]);
                var y0 = elevData[Math.round(x0)];
                var hCoords = queryPoints[Math.round(x0)];
                hover.setLatLng([hCoords[0], hCoords[1]]);
                hover.addTo(map);
                focusElev.attr('transform', 'translate(' + x1(x0) + ',' + y1(y0) + ')');
                focusElev.select('text').text(elevData[Math.round(x0)] + ' meters');
            }
        }
    });

    $('.refresh').on('click', function(){
        document.location.reload(true);
    })

    getLocation();
    marker.addTo(map);

</script>
</body>
</html>

